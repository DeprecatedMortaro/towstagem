#!/usr/bin/env ruby
action = ARGV.first
if action == 'new'
  project = ARGV[1]
  Dir.mkdir project
  configru = "require './app'\n"
  configru += "run Sinatra::Application"
  File.open("#{project}/config.ru", 'w') {|f| f.write(configru) }
  gemfile = "source :rubygems \n"
  gemfile += "gem 'towsta'"
  File.open("#{project}/Gemfile", 'w') {|f| f.write(gemfile) }
  apprb = "#coding: utf-8 \n"
  apprb += "require 'towsta'\n\n"
  apprb += "$towsta_secret = '#{ARGV[2]}'\n"
  apprb += "$towsta_cache = true\n\n"
  apprb += "get '/' do\n"
  apprb += "  sync_with_towsta\n"
  apprb += "  haml :index\n"
  apprb += "end\n"
  File.open("#{project}/app.rb", 'w') {|f| f.write(apprb) }
  Dir.mkdir "#{project}/views"
  layout = "!!!\n"
  layout += "%html\n"
  layout += "  %head\n"
  layout += "    = partial :head\n"
  layout += "  %body\n"
  layout += "    #top\n"
  layout += "      .wrapper\n"
  layout += "    #middle\n"
  layout += "      .wrapper\n"
  layout += "        = yield\n"
  layout += "    #bottom\n"
  layout += "      .wrapper\n"
  File.open("#{project}/views/layout.haml", 'w') {|f| f.write(layout)}
  index = '%h1 Hello Towsta'
  File.open("#{project}/views/index.haml", 'w') {|f| f.write(index)}
  Dir.mkdir "#{project}/models"
  Dir.mkdir "#{project}/public"
  Dir.mkdir "#{project}/views/stylesheets"
  css = "@import compass/reset\n"
  css += "@import compass/css3\n\n"
  css += "$wrapper: 940px\n\n"
  css += ".wrapper\n"
  css += "  :width $wrapper\n"
  css += "  :margin 0 auto\n"
  css += "#top, #middle, #bottom\n"
  css += "  :float left\n"
  css += "  :width 100%"
  File.open("#{project}/views/stylesheets/#{project}.sass", 'w') {|f| f.write(css)}
  Dir.mkdir "#{project}/views/partials"
  head = "%title #{project}\n"
  head += "%meta{'http-equiv' => 'Content-Type', :content => 'text/html', :charset => 'utf-8'}\n"
  head += "%link{:rel => 'stylesheet', :type =>'text/css', :href => '/stylesheets/#{project}.css'}\n"
  head += "%link{:rel => 'shortcut icon', :type=> 'image/x-icon', :href => '/images/favicon.png'}\n"
  head += "%script{:src => '/js/jquery.js'}\n"
  head += "%script{:src => '/js/#{project}.js'}"
  File.open("#{project}/views/partials/_head.haml", 'w') {|f| f.write(head)}
  Dir.mkdir "#{project}/public/js"
  js = "$(function() {\n\n"
  js += "});"
  File.open("#{project}/public/js/#{project}.js", 'w') {|f| f.write(js)}
  Dir.mkdir "#{project}/public/images"
elsif action == 'server'
  port = ARGV[1].nil? ? '6969' : ARGV[1]
  system "shotgun -I . config.ru -p #{port}"
  puts "Towsta server runnig at http://localhost:6969/"
elsif action == 'console'
  system 'irb -r ./app.rb'
  system 'sync_with_towsta'
elsif action == 'help'
  puts 'towsta new {projectname} {optional: secret}           to generate a new project'
  puts 'towsta server {optional: port}                        to run the application'
  puts 'towsta console                                        to run the application console'
else
  puts 'Comand not found, try running "towsta help"'
end
